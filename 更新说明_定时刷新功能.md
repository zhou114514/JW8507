# 定时刷新功能更新说明

## 更新日期
2026-01-21

## 问题描述
1. **设置后立即更新UI** - 但如果设置失败，UI还是显示了新值，与实际设备状态不符
2. **远程控制不同步** - 通过TCP服务器远程设置后，界面不会自动更新
3. **没有从设备读取实际值** - 显示的是预期值而非实际值

## 解决方案

### 1. 启用定时器自动刷新
- 在 `ChannelWidget.__init__()` 中自动启动定时器
- 每隔一定时间（默认500ms）自动从设备读取实际值并更新显示
- 这样可以确保UI始终反映设备的真实状态

### 2. 移除立即更新逻辑
修改了以下方法，不再在设置后立即更新LCD显示：
- `_on_set_attenuation()` - 设置衰减后不再立即更新LCD，而是让定时器自动刷新
- `_on_reset_channel()` - 重置通道后不再立即更新显示值
- `_on_close_channel()` - 关断通道后不再立即更改LCD颜色

### 3. 增强刷新逻辑
在 `refresh_display()` 方法中：
- 从设备读取实时信息（衰减值、波长等）
- 自动更新LCD显示的衰减值
- 自动同步波长下拉框（如果波长被远程修改）
- 添加错误日志过滤，避免频繁输出相同错误

### 4. 可配置刷新间隔
在 `config.json` 中添加了 `refresh_interval_ms` 配置项：
```json
{
    "refresh_interval_ms": 500
}
```

用户可以根据需要调整刷新频率：
- 更快的刷新（如100ms）- 响应更快，但串口通信负担更重
- 更慢的刷新（如1000ms）- 减轻串口负担，但响应稍慢

## 文件修改清单

### 1. `ChannelWidget.py`
- **修改 `__init__()`**: 添加 `refresh_interval` 参数，初始化 `_last_refresh_failed` 标志
- **修改 `_setup_refresh_timer()`**: 自动启动定时器，使用配置的刷新间隔
- **修改 `refresh_display()`**: 增强刷新逻辑，同时更新衰减值和波长信息，添加错误过滤
- **修改 `_on_set_attenuation()`**: 移除立即更新LCD的代码
- **修改 `_on_reset_channel()`**: 移除立即更新显示值的代码
- **修改 `_on_close_channel()`**: 移除立即更改LCD颜色的代码

### 2. `main.py`
- **修改 `_load_config()`**: 在默认配置中添加 `refresh_interval_ms` 配置项
- **修改 `_add_channel_widgets()`**: 从配置读取刷新间隔并传递给 `ChannelWidget`

### 3. `config.json`
- **添加配置项**: `refresh_interval_ms: 500` （默认500毫秒刷新一次）

## 使用效果

### 优点
1. ✅ **UI始终正确** - 显示的是设备实际状态，不是预期状态
2. ✅ **远程控制同步** - TCP远程设置后，界面会自动更新
3. ✅ **设置失败可见** - 如果设置失败，LCD会继续显示旧值，不会误导
4. ✅ **支持多种控制方式** - 无论是本地UI、远程TCP、还是仪器面板操作，都能正确同步

### 注意事项
1. ⚠️ **刷新间隔权衡**:
   - 间隔太短（如50ms）- 串口通信压力大，可能影响设置命令的响应
   - 间隔太长（如2000ms）- 界面更新延迟明显
   - 建议范围：200-1000ms

2. ⚠️ **多通道并发**:
   - 如果有8个通道，每个通道500ms刷新一次
   - 理论上每秒有16次串口读操作
   - 在115200波特率下通常没有问题

3. ⚠️ **性能考虑**:
   - 如果发现界面卡顿，可以适当增加 `refresh_interval_ms` 的值
   - 如果需要更快响应，可以减小这个值

## 测试建议

1. **本地设置测试**:
   - 设置衰减值，观察LCD是否正确更新
   - 设置一个超范围的值（如70dB），应该被拒绝，LCD显示不变

2. **远程控制测试**:
   - 通过TCP客户端设置衰减值
   - 观察GUI界面是否在500ms内自动更新

3. **刷新间隔测试**:
   - 修改 `config.json` 中的 `refresh_interval_ms` 为不同值（如100, 500, 1000）
   - 观察界面更新速度和串口负载

4. **错误恢复测试**:
   - 断开设备连接
   - 观察日志是否只输出一次错误，而不是每500ms都输出
   - 重新连接设备后，界面应该自动恢复正常

## 配置示例

### 快速响应配置（适合单通道或少量通道）
```json
{
    "channel_count": 2,
    "refresh_interval_ms": 200
}
```

### 标准配置（推荐）
```json
{
    "channel_count": 2,
    "refresh_interval_ms": 500
}
```

### 低负载配置（适合多通道或慢速串口）
```json
{
    "channel_count": 8,
    "refresh_interval_ms": 1000
}
```

## 后续优化建议

1. **错峰刷新**: 如果有多个通道，可以让它们错开刷新时间，避免同时发送串口命令
2. **智能刷新**: 可以在用户操作时提高刷新频率，空闲时降低频率
3. **状态缓存**: 可以缓存上次读取的值，只在变化时更新UI和输出日志

